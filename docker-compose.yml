services:
  db:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wp
      MYSQL_PASSWORD: wp
      MYSQL_ROOT_PASSWORD: root
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - db_ms_data:/var/lib/mysql
      - ./db-seed:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 5s
      timeout: 3s
      retries: 20

  wordpress:
    image: wordpress:latest
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8002:80"
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: wp
      WORDPRESS_DB_PASSWORD: wp
      WORDPRESS_DB_NAME: wordpress
      WP_URL: http://localhost:8002
    volumes:
      - wp_ms_data:/var/www/html
      # (tuỳ chọn) mount scripts để dễ kiểm tra trong wordpress container
      - type: bind
        source: ./scripts
        target: /scripts
        read_only: true

  # Seed wp-content 1 lần nếu có dữ liệu mẫu
  init_wpfiles:
    image: bash:5.2
    depends_on:
      wordpress:
        condition: service_started
    volumes:
      - wp_ms_data:/var/www/html
      - ./content/wp-content:/seed/wp-content:ro
    command: >
      bash -lc "
        if [ ! -e /var/www/html/.seeded ] && [ -d /seed/wp-content ]; then
          shopt -s dotglob nullglob;
          mkdir -p /var/www/html/wp-content;
          cp -R /seed/wp-content/* /var/www/html/wp-content/ 2>/dev/null || true;
          chown -R 33:33 /var/www/html/wp-content || true;
          touch /var/www/html/.seeded;
          echo 'Seeded wp-content ✓';
        else
          echo 'Skip seeding (already seeded).';
        fi
      "
    restart: "no"

  # Bật Multisite tự động (chạy với quyền root + trace để thấy log)
  init_multisite:
    image: wordpress:cli
    user: "0:0"                # <-- chạy dưới quyền root để có quyền ghi
    depends_on:
      db:
        condition: service_healthy
      wordpress:
        condition: service_started
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: wp
      WORDPRESS_DB_PASSWORD: wp
      WORDPRESS_DB_NAME: wordpress
      WP_URL: http://localhost:8002
      WP_CLI_ALLOW_ROOT: "1"
    volumes:
      - wp_ms_data:/var/www/html
      - type: bind
        source: ./scripts
        target: /scripts
        read_only: false
    tty: true
    stdin_open: true
    entrypoint: [""]
    command: ["bash", "-x", "/scripts/init_multisite.sh"]
    restart: "no"

volumes:
  db_ms_data:
  wp_ms_data:
